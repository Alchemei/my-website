<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>English Master v7.2 Hybrid</title>
    
    <!-- Font: Manrope -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- CSS VARIABLES (AURORA THEME) --- */
        :root {
            --bg-dark: #050505;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-surface: rgba(255, 255, 255, 0.03);
            
            --neon-blue: #3b82f6;
            --neon-purple: #8b5cf6;
            --neon-green: #10b981;
            --neon-orange: #f59e0b;
            --neon-red: #ef4444;
            
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            
            --radius-xl: 32px;
            --radius-lg: 20px;
            --nav-height: 70px;
        }

        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column;
            position: relative;
        }

        /* --- BACKGROUND --- */
        .aurora-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden;
            background: radial-gradient(circle at 50% 0%, #1e1b4b, #000000);
        }
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--neon-purple); top: -10%; left: -10%; animation-delay: 0s; }
        .orb-2 { width: 250px; height: 250px; background: var(--neon-blue); bottom: 20%; right: -10%; animation-delay: -5s; }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, 50px); }
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        
        .btn {
            border: none; cursor: pointer; font-family: inherit; font-weight: 700;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.95); }

        /* --- HEADER --- */
        header {
            padding: 20px; z-index: 10; flex-shrink: 0;
            display: flex; flex-direction: column; gap: 15px;
        }
        .hud-top { display: flex; justify-content: space-between; align-items: center; }
        .hud-badge {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            padding: 8px 16px; border-radius: 100px;
            font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(10px);
        }
        .streak-badge { color: var(--neon-orange); box-shadow: 0 0 15px rgba(245, 158, 11, 0.1); }
        .currency-badge { color: var(--neon-green); box-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
        
        .xp-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.1);
            border-radius: 10px; overflow: hidden; position: relative;
        }
        .xp-fill {
            height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            width: 0%; transition: width 0.6s ease;
            box-shadow: 0 0 10px var(--neon-purple);
        }

        /* --- MAIN --- */
        main {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 0 20px 100px 20px;
        }
        
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .login-logo { font-size: 3rem; margin-bottom: 20px; animation: float 6s infinite ease-in-out; }
        .google-btn {
            background: white; color: #333; width: 100%; max-width: 300px;
            padding: 15px; border-radius: 30px; font-size: 1rem; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .guest-btn {
            background: transparent; color: var(--text-muted); 
            border: 1px solid var(--glass-border); width: 100%; max-width: 300px;
            padding: 12px; border-radius: 30px; font-size: 0.9rem;
        }

        /* --- LEARN --- */
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .progress-text { font-family: 'Courier New', monospace; color: var(--neon-blue); font-weight: 700; }

        .flashcard-container { perspective: 1200px; height: 360px; width: 100%; cursor: pointer; }
        .flashcard {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: var(--radius-xl);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .card-face::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            opacity: 0.5; pointer-events: none;
        }
        .card-back { transform: rotateY(180deg); background: linear-gradient(145deg, rgba(139, 92, 246, 0.2), rgba(0,0,0,0.8)); border-color: var(--neon-purple); }

        .word-lg { font-size: 2.8rem; font-weight: 800; margin-bottom: 10px; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .word-context { font-size: 1rem; color: var(--text-muted); font-style: italic; margin-bottom: 30px; max-width: 80%; line-height: 1.6; }
        .word-meaning { font-size: 2.2rem; font-weight: 700; color: var(--neon-purple); text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }

        /* Card Actions */
        .card-actions { 
            display: flex; gap: 20px; z-index: 2;
            transition: opacity 0.1s 0.2s; opacity: 1;
        }
        .flashcard.flipped .card-actions { opacity: 0; pointer-events: none; }

        .action-btn {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255,255,255,0.05); color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); border-color: white; }

        .vote-container { display: flex; gap: 15px; margin-top: 30px; }
        .vote-btn {
            flex: 1; padding: 18px; border-radius: 24px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
            color: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .vote-fail { background: linear-gradient(135deg, #ff7e7e, #ef4444); color: white; }
        .vote-success { background: linear-gradient(135deg, #6ee7b7, #10b981); color: #064e3b; }

        /* --- QUESTS --- */
        .quest-card { display: flex; flex-direction: column; gap: 10px; padding: 20px; margin-bottom: 15px; }
        .quest-card.completed { border-color: var(--neon-green); background: linear-gradient(90deg, rgba(16,185,129,0.1), transparent); }
        .quest-row { display: flex; justify-content: space-between; align-items: center; }
        .quest-title { font-weight: 600; font-size: 1rem; }
        .quest-reward { background: rgba(245, 158, 11, 0.2); color: var(--neon-orange); padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; }
        
        /* --- QUIZ --- */
        .quiz-counter { background: rgba(59, 130, 246, 0.2); color: var(--neon-blue); padding: 6px 12px; border-radius: 20px; font-family: monospace; }
        .quiz-opt {
            width: 100%; padding: 20px; margin-top: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg); color: white; text-align: left; transition: all 0.2s;
        }
        .quiz-opt:active { background: rgba(255,255,255,0.1); }

        /* --- SHOP --- */
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin-bottom: 15px; }
        .item-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .price-btn { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 100px; color: var(--neon-orange); font-weight: 700; border: 1px solid rgba(245, 158, 11, 0.3); }

        /* --- NAV --- */
        .nav-dock-container { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; pointer-events: none; z-index: 50; }
        .nav-dock {
            pointer-events: auto; background: rgba(15, 15, 20, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15); padding: 0 25px; height: 60px;
            border-radius: 100px; display: flex; gap: 25px; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .nav-item { background: none; border: none; padding: 0; cursor: pointer; color: rgba(255,255,255,0.4); position: relative; display: flex; align-items: center; justify-content: center; transition: color 0.3s; }
        .nav-item svg { width: 20px; height: 20px; stroke-width: 2.5; }
        .nav-item.active { color: white; }
        .nav-item.active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--neon-blue); border-radius: 50%; box-shadow: 0 0 10px var(--neon-blue); }

        /* --- TOAST --- */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); color: #000; padding: 12px 24px;
            border-radius: 100px; z-index: 200; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }
        #confetti-canvas { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:150; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- CHART STYLES --- */
        .chart-container {
            display: flex; align-items: flex-end; justify-content: space-between;
            height: 150px; margin-top: 20px; padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }
        .chart-bar-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1;
        }
        .chart-bar {
            width: 8px; background: var(--neon-blue); border-radius: 10px;
            transition: height 1s ease; min-height: 4px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }
        .chart-label { font-size: 0.7rem; color: var(--text-muted); }
        
        /* Progress Ring */
        .progress-ring-container { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; }
        .progress-ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring-circle-bg { fill: transparent; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
        .progress-ring-circle {
            fill: transparent; stroke: var(--neon-green); stroke-width: 8;
            stroke-dasharray: 339.292; stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 1s; stroke-linecap: round;
        }
        .progress-ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        
        /* --- AUTH STATUS --- */
        .auth-status {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="aurora-bg"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>
    <canvas id="confetti-canvas"></canvas>
    <div id="toast">İşlem Başarılı</div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-logo">⚡</div>
        <h1 style="margin-bottom:5px;">English Master</h1>
        <p style="color:var(--text-muted); margin-bottom:40px;">Personal Cloud Edition</p>
        
        <button class="btn google-btn" onclick="loginWithGoogle()">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="currentColor"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.16 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
            Google ile Giriş Yap
        </button>
        
        <button class="btn guest-btn" onclick="loginGuest()">Misafir Olarak Devam Et</button>
        <p style="font-size:0.7rem; color:var(--text-muted); margin-top:20px; max-width:250px;">Not: Giriş yapmazsan veriler sadece bu cihazda saklanır.</p>
    </div>

    <header>
        <div class="hud-top">
            <div class="hud-badge streak-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>
                <span id="streak-display">0</span>
            </div>
            <div class="hud-badge currency-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"></circle><path d="M16 12h.01"></path><path d="M12 16h.01"></path><path d="M8 12h.01"></path><path d="M12 8h.01"></path></svg>
                <span id="coin-display">0</span>
            </div>
        </div>
        <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
    </header>

    <main>
        <!-- LEARN -->
        <div id="tab-learn" class="fade-in">
            <div class="page-header">
                <div><div class="page-title">Günlük Oturum</div><h1 style="margin:0; font-size:1.8rem; font-weight:300;">Öğren</h1></div>
                <div class="progress-text" id="learn-progress-text">0 / 1000</div>
            </div>
            
            <div class="flashcard-container" onclick="flipCard()">
                <div class="flashcard" id="flashcard">
                    <div class="card-face card-front">
                        <div class="word-lg" id="fc-en">...</div>
                        <div class="word-context" id="fc-ctx">...</div>
                        <div class="card-actions" onclick="event.stopPropagation()">
                            <button class="btn action-btn" onclick="playTTS()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
                            <button class="btn action-btn" onclick="toggleFav()"><svg id="fav-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></button>
                        </div>
                        <div style="margin-top:auto; font-size:0.7rem; letter-spacing:1px; text-transform:uppercase; opacity:0.5;">Çevirmek için dokun</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="word-meaning" id="fc-tr">...</div>
                    </div>
                </div>
            </div>

            <div class="vote-container">
                <button class="btn vote-btn vote-fail" onclick="vote(false)">Tekrar</button>
                <button class="btn vote-btn vote-success" onclick="vote(true)">Biliyorum</button>
            </div>
        </div>

        <!-- QUESTS -->
        <div id="tab-quests" class="hidden fade-in">
            <div class="page-header"><h1 style="margin:0; font-size:1.8rem; font-weight:300;">Görevler</h1><div class="page-title">Sıfırlanma 00:00</div></div>
            <div id="quests-container"></div>
        </div>

        <!-- QUIZ -->
        <div id="tab-quiz" class="hidden fade-in">
            <div id="quiz-play-area">
                <div class="page-header"><h1 style="margin:0; font-size:1.8rem; font-weight:300;">Quiz</h1><span id="quiz-counter" class="quiz-counter">1 / 20</span></div>
                <div class="glass-panel" style="text-align:center; padding:40px 20px;">
                    <div style="color:var(--text-muted); margin-bottom:15px;">Bu kelimenin anlamı?</div>
                    <h1 id="q-word" style="color:white; margin:0 0 30px 0; font-size:2.5rem; font-weight:800; text-shadow:0 0 30px rgba(255,255,255,0.2);">...</h1>
                    <div id="q-options"></div>
                </div>
            </div>
            <div id="quiz-result-area" class="hidden fade-in">
                <div class="glass-panel" style="padding:40px; text-align:center;">
                    <h2 style="font-size:2rem; margin:0;">Tamamlandı</h2>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:30px 0;">
                        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px;"><div style="font-size:0.8rem; color:var(--text-muted);">Doğru</div><div id="res-score" style="font-size:1.8rem; font-weight:700; color:var(--neon-green);">0</div></div>
                        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px;"><div style="font-size:0.8rem; color:var(--text-muted);">XP</div><div id="res-xp" style="font-size:1.8rem; font-weight:700; color:var(--neon-blue);">0</div></div>
                    </div>
                    <button class="btn w-full" style="padding:18px; background:var(--neon-blue); color:white; border-radius:16px;" onclick="resetQuiz()">Tekrar Başla</button>
                </div>
            </div>
        </div>

        <!-- SHOP -->
        <div id="tab-shop" class="hidden fade-in">
            <div class="page-header"><h1 style="margin:0; font-size:1.8rem; font-weight:300;">Market</h1><div class="page-title">Güçlendirmeler</div></div>
            <div id="active-buffs-container" style="margin-bottom:20px;"></div>
            <div class="glass-panel shop-item">
                <div style="display:flex; gap:15px; align-items:center;"><div class="item-icon" style="color:var(--neon-blue);">❄️</div><div><div style="font-weight:700;">Streak Freeze</div><div style="font-size:0.85rem; color:var(--text-muted);">Seri Koruma</div></div></div>
                <button id="btn-freeze" class="btn price-btn" onclick="buyItem('freeze', 200)">200</button>
            </div>
            <div class="glass-panel shop-item">
                <div style="display:flex; gap:15px; align-items:center;"><div class="item-icon" style="color:var(--neon-purple);">⚡</div><div><div style="font-weight:700;">Double XP</div><div style="font-size:0.85rem; color:var(--text-muted);">20x Soru Bonusu</div></div></div>
                <button id="btn-double" class="btn price-btn" onclick="buyItem('double', 350)">350</button>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="tab-profile" class="hidden fade-in">
            <div style="text-align:center; margin-bottom:30px; margin-top:20px;">
                
                <!-- Auth Status -->
                <div class="auth-status" id="auth-status-display">
                    <div style="width:10px; height:10px; border-radius:50%; background:var(--text-muted); margin-right:5px;" id="auth-dot"></div>
                    <span id="auth-text" style="font-size:0.9rem; font-weight:700;">Bağlanıyor...</span>
                </div>

                <div class="progress-ring-container">
                    <svg class="progress-ring-svg">
                        <circle class="progress-ring-circle-bg" r="54" cx="60" cy="60"></circle>
                        <circle class="progress-ring-circle" id="mastery-ring" r="54" cx="60" cy="60"></circle>
                    </svg>
                    <div class="progress-ring-text">
                        <div id="mastery-pct" style="font-size:1.5rem; font-weight:800; color:var(--neon-green);">0%</div>
                        <div style="font-size:0.7rem; color:var(--text-muted);">USTALIK</div>
                    </div>
                </div>
                <h2 style="margin:0;">Profilim</h2>
                <div id="career-badge" style="color:var(--neon-blue); font-family:monospace; margin-top:5px;">Lvl 1 • Stajyer</div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:30px;">
                <div class="glass-panel" style="padding:20px; text-align:center;">
                    <div id="stat-xp" style="font-size:1.8rem; font-weight:800; color:var(--neon-blue);">0</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Toplam XP</div>
                </div>
                <div class="glass-panel" style="padding:20px; text-align:center;">
                    <div id="stat-words" style="font-size:1.8rem; font-weight:800; color:var(--neon-green);">0</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Öğrenilen (Toplam)</div>
                </div>
            </div>

            <h3 style="font-weight:300; margin-bottom:15px;">Haftalık Aktivite</h3>
            <div class="glass-panel" style="padding:15px; margin-bottom:30px;">
                <div id="weekly-chart" class="chart-container">
                    <!-- Bars injected by JS -->
                </div>
            </div>

            <h3 style="font-weight:300; border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:15px;">Favoriler</h3>
            <div id="favorites-list" style="min-height:50px; margin-bottom:30px;"><div style="color:var(--text-muted); font-size:0.9rem; text-align:center;">Liste boş.</div></div>
            
            <button class="btn w-full" style="padding:15px; background:var(--glass-surface); color:var(--text-muted); border:1px solid var(--glass-border); border-radius:16px;" onclick="logout()">Çıkış Yap</button>
        </div>
    </main>

    <div class="nav-dock-container">
        <nav class="nav-dock">
            <button class="nav-item active" onclick="switchTab('learn', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg></button>
            <button class="nav-item" onclick="switchTab('quests', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg></button>
            <button class="nav-item" onclick="switchTab('quiz', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg></button>
            <button class="nav-item" onclick="switchTab('shop', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><path d="M3 6h18"></path><path d="M16 10a4 4 0 0 1-8 0"></path></svg></button>
            <button class="nav-item" onclick="switchTab('profile', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- USER PROVIDED CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDUN827ZeD2YhEYAkB5OeWkF6OIiF59bFI",
          authDomain: "learning-eng-cc8e5.firebaseapp.com",
          projectId: "learning-eng-cc8e5",
          storageBucket: "learning-eng-cc8e5.firebasestorage.app",
          messagingSenderId: "443233964962",
          appId: "1:443233964962:web:d7181e4bb4e2377c5898fb",
          measurementId: "G-K60HHNSBQ2"
        };

        // --- 1000 CORE WORDS ---
        const rawWordData = "the|o, şu|The book is here;of|-in/-ın|Piece of cake;and|ve|You and me;a|bir|A cat;to|-e/-a|Go to school;in|içinde|In the box;is|dır/dir|He is tall;you|sen|You look good;that|şu/o|That is amazing;it|o|It is raining;he|o (erkek)|He is my brother;was|idi|It was fun;for|için|This is for you;on|üzerinde|On the table;are|dır/dir (çoğul)|We are happy;as|gibi/olarak|As soon as possible;with|ile|Come with me;his|onun (erkek)|His car is red;they|onlar|They are here;I|ben|I am fine;at|-de/-da|At home;be|olmak|Be yourself;this|bu|This is mine;have|sahip olmak|I have a dog;from|-den/-dan|From New York;or|veya|Coffee or tea;one|bir|One moment;had|sahip idi|I had a dream;by|tarafından|By the way;word|kelime|Just one word;but|ama|But why?;not|değil|Not today;what|ne|What is this?;all|hepsi|All of us;were|idiler|They were happy;we|biz|We are family;when|ne zaman|When is it?;your|senin|Your turn;can|yapabilmek|I can fly;said|dedi|He said no;there|orada|Over there;use|kullanmak|Use it wisely;an|bir|An apple;each|her biri|Each person;which|hangi|Which one?;she|o (kadın)|She is smart;do|yapmak|Do it now;how|nasıl|How are you?;their|onların|Their house;if|eğer|If you want;will|ecek/acak|I will go;up|yukarı|Look up;other|diğer|Other side;about|hakkında|About time;out|dışarı|Get out;many|çok|Many people;then|sonra|Then what?;them|onları|Tell them;these|bunlar|These shoes;so|böylece/çok|So good;some|bazı|Some water;her|onun (kadın)|Her bag;would|cekti/caktı|I would go;make|yapmak|Make tea;like|gibi/sevmek|Like this;him|onu|Tell him;into|içine|Into the wild;time|zaman|Time flies;has|sahip (o)|He has it;look|bakmak|Look at me;two|iki|Two days;more|daha|More please;write|yazmak|Write a letter;go|gitmek|Let's go;see|görmek|I see you;number|numara|Number one;no|hayır|No thanks;way|yol|This way;could|yapabilirdi|Could you help?;people|insanlar|Happy people;my|benim|My car;than|-den (karşılaştırma)|Better than you;first|birinci|First place;water|su|Drink water;been|olmuş|Has been;call|aramak|Call me;who|kim|Who is it?;oil|yağ|Olive oil;its|onun (cansız)|Its color;now|şimdi|Do it now;find|bulmak|Find the key;long|uzun|Long time;down|aşağı|Sit down;day|gün|Good day;did|yaptı|He did it;get|almak|Get ready;come|gelmek|Come here;made|yapılmış|Made in China;may|olabilir|May I?;part|parça|Part of me;over|üzerinde/bitmiş|Game over;new|yeni|New phone;sound|ses|Good sound;take|almak|Take it;only|sadece|Only you;little|küçük|Little bit;work|iş/çalışmak|Good work;know|bilmek|I know;place|yer|Nice place;year|yıl|Next year;live|yaşamak|Live fast;me|bana/beni|Look at me;back|geri|Come back;give|vermek|Give up;most|en çok|Most people;very|çok|Very good;after|sonra|After lunch;thing|şey|Good thing;our|bizim|Our house;just|sadece|Just now;name|isim|My name;good|iyi|Good job;sentence|cümle|Long sentence;man|adam|Tall man;think|düşünmek|Think big;say|söylemek|Say hello;great|harika|Great day;where|nerede|Where is it?;help|yardım|Help me;through|içinden/arasından|Through the door;much|çok|Too much;before|önce|Before me;line|çizgi|Draw a line;right|sağ/doğru|Turn right;too|de/da/çok|Me too;mean|anlamına gelmek|What do you mean?;old|eski/yaşlı|Old car;any|herhangi|Any ideas?;same|aynı|Same here;tell|anlatmak|Tell a story;boy|oğlan|Good boy;follow|takip etmek|Follow me;came|geldi|He came;want|istemek|I want it;show|göstermek|Show me;also|ayrıca|Me also;around|etrafında|Look around;farm|çiftlik|Big farm;three|üç|Three cats;small|küçük|Small box;set|ayarlamak/set|Set go;put|koymak|Put it there;end|son|The end;does|yapar|He does it;another|başka|Another one;well|iyi|Well done;large|geniş|Large size;must|meli/malı|Must go;big|büyük|Big house;even|bile|Even me;such|böyle|Such a day;because|çünkü|Because why;turn|dönmek|Turn left;here|burada|I am here;why|neden|Why not?;ask|sormak|Ask him;went|gitti|He went home;men|adamlar|Two men;read|okumak|Read this;need|ihtiyaç duymak|I need you;land|arazi|My land;different|farklı|Different color;home|ev|Go home;us|bize|Join us;move|hareket etmek|Move it;try|denemek|Try again;kind|tür/nazik|Be kind;hand|el|My hand;picture|resim|Nice picture;again|tekrar|Try again;change|değişim|Change is good;off|kapalı|Turn off;play|oynamak|Play game;spell|hecelemek|Spell it;air|hava|Fresh air;away|uzak|Go away;animal|hayvan|Wild animal;house|ev|My house;point|nokta|Good point;page|sayfa|Page one;letter|mektup/harf|Write a letter;mother|anne|My mother;answer|cevap|Answer me;found|bulundu|Found it;study|çalışmak (ders)|Study hard;still|hala|Still here;learn|öğrenmek|Learn English;should|meli/malı|Should go;America|Amerika|In America;world|dünya|Hello world;high|yüksek|High jump;every|her|Every day;near|yakın|Near me;add|eklemek|Add sugar;food|yemek|Good food;between|arasında|Between us;own|kendi|My own;below|aşağıda|Look below;country|ülke|My country;plant|bitki|Green plant;last|son|Last one;school|okul|At school;father|baba|My father;keep|tutmak|Keep it;tree|ağaç|Tall tree;never|asla|Never mind;city|şehir|Big city;earth|dünya|Planet Earth;eye|göz|Blue eye;light|ışık|Turn on light;thought|düşünce|Good thought;head|kafa|My head;under|altında|Under water;story|hikaye|Tell a story;saw|gördü|I saw it;left|sol/ayrıldı|Turn left;don't|yapma|Don't stop;few|az|Few people;while|iken|While walking;along|boyunca|Come along;might|olabilir|It might rain;close|kapalı/yakın|Close the door;something|bir şey|Say something;seem|görünmek|Seems good;next|sonraki|Next time;hard|zor/sert|Work hard;open|açık|Open it;example|örnek|For example;begin|başlamak|Begin now;life|hayat|Life is good;always|her zaman|Always smile;those|şunlar|Those cars;both|ikisi de|Both of us;paper|kağıt|White paper;together|birlikte|Go together;got|aldı|I got it;group|grup|Small group;often|sık sık|Often visit;run|koşmak|Run fast;important|önemli|Important news;until|-e kadar|Until tomorrow;children|çocuklar|Happy children;side|yan/taraf|Side by side;feet|ayaklar|Two feet;car|araba|Fast car;mile|mil|One mile;night|gece|Good night;walk|yürümek|Walk away;white|beyaz|White snow;sea|deniz|Blue sea;began|başladı|It began;grow|büyümek|Plants grow;took|aldı|He took it;river|nehir|Long river;four|dört|Four cats;carry|taşımak|Carry this;state|eyalet/durum|New York State;once|bir kez|Once upon a time;book|kitap|Read book;hear|duymak|Hear music;stop|durmak|Stop now;without|olmadan|Without you;second|saniye/ikinci|Wait a second;late|geç|Too late;miss|özlemek/kaçırmak|Miss you;idea|fikir|Good idea;enough|yeterli|Enough food;eat|yemek|Eat apple;face|yüz|Wash face;watch|izlemek|Watch TV;far|uzak|Far away;Indian|Hintli|Indian food;real|gerçek|Real love;almost|neredeyse|Almost there;let|izin vermek|Let me go;above|yukarıda|Look above;girl|kız|Happy girl;sometimes|bazen|Sometimes cry;mountains|dağlar|High mountains;cut|kesmek|Cut paper;young|genç|Young man;talk|konuşmak|Talk to me;soon|yakında|See soon;list|liste|To-do list;song|şarkı|Sing a song;being|olma|Being happy;leave|ayrılmak|Leave me;family|aile|Big family;it's|o (kısaltma)|It's time;body|vücut|My body;music|müzik|Loud music;color|renk|Red color;stand|ayakta durmak|Stand up;sun|güneş|Hot sun;questions|sorular|Any questions?;fish|balık|Swim fish;area|alan|Rest area;mark|işaret|Check mark;dog|köpek|Good dog;horse|at|Ride horse;birds|kuşlar|Fly birds;problem|sorun|No problem;complete|tamamlamak|Complete it;room|oda|My room;knew|biliyordu|I knew it;since|-den beri|Since 1990;ever|hiç|Ever been?;piece|parça|Piece of cake;told|söyledi|He told me;usually|genellikle|Usually late;didn't|yapmadı|Didn't know;friends|arkadaşlar|Best friends;easy|kolay|Easy task;heard|duydu|I heard that;order|sipariş/düzen|Order pizza;red|kırmızı|Red car;door|kapı|Open door;sure|emin|Are you sure?;become|olmak|Become rich;top|üst|Top floor;ship|gemi|Big ship;across|karşıya|Across the street;today|bugün|Not today;during|sırasında|During class;short|kısa|Short hair;better|daha iyi|Better now;best|en iyi|Best friend;however|bununla birlikte|However, I will go;low|düşük|Low battery;hours|saatler|Two hours;black|siyah|Black cat;products|ürünler|New products;happened|oldu|What happened?;whole|bütün|Whole pizza;measure|ölçmek|Measure it;remember|hatırlamak|Remember me;early|erken|Early bird;waves|dalgalar|Big waves;reached|ulaştı|Reached home;listen|dinlemek|Listen to me;wind|rüzgar|Cold wind;rock|kaya|Hard rock;space|uzay/boşluk|Outer space;covered|kaplı|Covered in snow;fast|hızlı|Run fast;several|birkaç|Several days;hold|tutmak|Hold on;himself|kendisi|He hurt himself;toward|doğru|Walk toward;five|beş|Five stars;step|adım|Step back;morning|sabah|Good morning;passed|geçti|Passed away;vowel|ünlü harf|A E I O U;true|doğru|True story;hundred|yüz|One hundred;against|karşı|Against the wall;pattern|desen|Nice pattern;numeral|sayısal|Roman numeral;table|masa|On the table;north|kuzey|Go north;slowly|yavaşça|Walk slowly;money|para|Need money;map|harita|World map;busy|meşgul|Busy now;pulled|çekti|Pulled over;draw|çizmek|Draw a picture;voice|ses|Loud voice;seen|görülmüş|Seen it;cold|soğuk|Cold water;cried|ağladı|She cried;plan|plan|Good plan;notice|fark etmek|Did you notice?;south|güney|Go south;sing|şarkı söylemek|Sing loud;war|savaş|Stop war;ground|yer|On the ground;fall|düşmek|Fall down;king|kral|Lion king;town|kasaba|Small town;I'll|yapacağım|I'll do it;unit|birim|Unit one;figure|şekil/rakam|Figure it out;certain|kesin|Certain death;field|tarla/alan|Soccer field;travel|seyahat|Travel fast;wood|odun|Chop wood;fire|ateş|Hot fire;upon|üzerine|Once upon;done|yapılmış|Well done;English|İngilizce|Learn English;road|yol|Long road;half|yarım|Half full;ten|on|Ten days;fly|uçmak|Birds fly;gave|verdi|He gave it;box|kutu|Open box;finally|sonunda|Finally home;wait|beklemek|Wait here;correct|doğru|Correct answer;oh|oh|Oh no;quickly|hızlıca|Run quickly;person|kişi|Nice person;became|oldu|He became king;shown|gösterilmiş|Shown on TV;minutes|dakikalar|Five minutes;strong|güçlü|Strong man;verb|fiil|Action verb;stars|yıldızlar|Bright stars;front|ön|Front door;feel|hissetmek|Feel good;fact|gerçek|Fun fact;inches|inç|Two inches;street|cadde|Main street;decided|karar verdi|Decided to go;contain|içermek|Contain nuts;course|kurs/tabii|Of course;surface|yüzey|Smooth surface;produce|üretmek|Produce cars;building|bina|Tall building;ocean|okyanus|Deep ocean;class|sınıf|Math class;note|not|Take note;nothing|hiçbir şey|Nothing here;rest|dinlenmek|Rest now;carefully|dikkatlice|Drive carefully;scientists|bilim insanları|Smart scientists;inside|içinde|Look inside;wheels|tekerlekler|Car wheels;stay|kalmak|Stay safe;green|yeşil|Green grass;known|bilinen|Well known;island|ada|Tropical island;week|hafta|Last week;less|daha az|Less money;machine|makine|Big machine;base|taban/üs|Base camp;ago|önce|Long ago;stood|durdu|He stood up;plane|uçak|Fly plane;system|sistem|Solar system;behind|arkasında|Look behind;ran|koştu|He ran fast;round|yuvarlak|Round ball;boat|tekne|Sail boat;game|oyun|Video game;force|güç|Use force;brought|getirdi|Brought food;understand|anlamak|I understand;warm|ılık|Warm water;common|yaygın|Common cold;bring|getirmek|Bring it;explain|açıklamak|Explain this;dry|kuru|Dry clothes;though|rağmen|Even though;language|dil|Speak language;shape|şekil|Circle shape;deep|derin|Deep water;thousands|binlerce|Thousands of people;yes|evet|Yes please;clear|açık/net|Clear sky;equation|denklem|Math equation;yet|henüz|Not yet;government|hükümet|Big government;filled|dolu|Filled cup;heat|ısı|High heat;full|dolu|Full moon;hot|sıcak|Hot tea;check|kontrol|Check mate;object|nesne|Flying object;am|yım/yim|I am;rule|kural|Game rule;among|arasında|Among us;noun|isim|Proper noun;power|güç|Power on;cannot|yapamaz|Cannot go;able|yapabilir|Able to run;six|altı|Six cars;size|boyut|Big size;dark|karanlık|Dark night;ball|top|Kick ball;material|malzeme|Raw material;special|özel|Special day;heavy|ağır|Heavy box;fine|iyi|I am fine;pair|çift|Pair of shoes;circle|daire|Draw circle;include|içermek|Include me;built|inşa edilmiş|Built house;can't|yapamaz|Can't stop;matter|mesele|What matter?;square|kare|Square box;syllables|heceler|Two syllables;perhaps|belki|Perhaps later;bill|fatura|Pay bill;felt|hissetti|Felt good;suddenly|aniden|Suddenly stop;test|test|Math test;direction|yön|Wrong direction;center|merkez|City center;farmers|çiftçiler|Hard farmers;ready|hazır|Ready set go;anything|herhangi bir şey|Anything else?;divided|bölünmüş|Divided by;general|genel|General idea;energy|enerji|Solar energy;subject|konu|School subject;Europe|Avrupa|Visit Europe;moon|ay|Full moon;region|bölge|Cold region;return|dönüş|Return home;believe|inanmak|Believe me;dance|dans|Dance party;members|üyeler|Team members;picked|seçti|Picked apple;simple|basit|Simple math;cells|hücreler|Blood cells;paint|boya|Blue paint;mind|zihin|Open mind;love|aşk|True love;cause|sebep|Cause trouble;rain|yağmur|Heavy rain;exercise|egzersiz|Daily exercise;eggs|yumurtalar|Cook eggs;train|tren|Fast train;blue|mavi|Blue sky;wish|dilek|Make wish;drop|düşürmek|Drop it;developed|gelişmiş|Developed city;window|pencere|Open window;difference|fark|Big difference;distance|mesafe|Long distance;heart|kalp|My heart;site|site|Web site;sum|toplam|Sum up;summer|yaz|Hot summer;wall|duvar|Brick wall;forest|orman|Green forest;probably|muhtemelen|Probably yes;legs|bacaklar|Two legs;sat|oturdu|He sat down;main|ana|Main street;winter|kış|Cold winter;wide|geniş|Wide road;written|yazılı|Written test;length|uzunluk|Full length;reason|sebep|Good reason;kept|tuttu|Kept safe;interest|ilgi|High interest;arms|kollar|Strong arms;brother|erkek kardeş|Big brother;race|yarış|Car race;present|hediye/sunmak|Birthday present;beautiful|güzel|Beautiful day;store|mağaza|Grocery store;job|iş|Good job;edge|kenar|Sharp edge;past|geçmiş|In the past;sign|işaret|Stop sign;record|kayıt|World record;finished|bitti|Finished work;discovered|keşfedildi|Discovered land;wild|vahşi|Wild animal;happy|mutlu|Happy face;beside|yanında|Sit beside;gone|gitmiş|He is gone;sky|gökyüzü|Blue sky;glass|cam|Glass cup;million|milyon|One million;west|batı|Go west;lay|yatmak|Lay down;weather|hava|Good weather;root|kök|Tree root;instruments|enstrümanlar|Musical instruments;meet|buluşmak|Meet me;third|üçüncü|Third place;months|aylar|Twelve months;paragraph|paragraf|Short paragraph;raised|kaldırdı|Raised hand;represent|temsil etmek|Represent us;soft|yumuşak|Soft pillow;whether|olup olmadığı|Whether or not;clothes|kıyafetler|New clothes;flowers|çiçekler|Red flowers;shall|cek/cak|Shall we?;teacher|öğretmen|Best teacher;held|tuttu|Held hands;describe|tanımlamak|Describe it;drive|sürmek|Drive car";

        const taskTemplates = [
            { id: 'learn', text: '5 Yeni Kelime', target: 5, reward: 50, type: 'learn' },
            { id: 'xp', text: '100 XP Kazan', target: 100, reward: 30, type: 'xp' },
            { id: 'quiz', text: 'Quiz Tamamla', target: 1, reward: 40, type: 'quiz' }
        ];

        // STATE
        let db, auth, user, docRef;
        let app = { 
            xp: 0, coins: 200, streak: 1, learned: [], favs: [], 
            wordIndex: 0, lastLogin: new Date().toDateString(), tasks: [],
            activeItems: { freeze: false, doubleXP: 0 },
            history: {},
            isGuest: false
        };
        
        let words = [];
        let isFlipped = false;
        let quizState = { active: false, currentQ: 0, score: 0, totalQ: 20 };

        let firebaseApp;

        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            fallbackToLocal();
        }

        // HELPER: Fallback to Local Storage if Cloud fails
        function fallbackToLocal() {
            console.log("Switching to Local Storage Mode");
            app.isGuest = true;
            updateAuthStatus(false, true); // Logged in as Local Guest
            loadLocalData();
            document.getElementById('login-screen').classList.add('hidden');
        }

        function loadLocalData() {
            const saved = localStorage.getItem('engApp_v72_local');
            if(saved) {
                try {
                    let parsed = JSON.parse(saved);
                    app = { ...app, ...parsed };
                    if(!app.history) app.history = {};
                } catch(e) {}
            }
            initAppLogic();
        }

        function initAppLogic() {
            checkDailyTasks();
            updateHistory(0);
            updateUI();
            findNextWord();
        }

        // INIT
        parseWords();

        if (auth) {
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    user = u;
                    app.isGuest = false;
                    document.getElementById('login-screen').classList.add('hidden');
                    updateAuthStatus(true);
                    
                    const userId = user.uid;
                    docRef = doc(db, 'users', userId);
                    
                    onSnapshot(docRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const cloudData = snapshot.data();
                            app = { ...app, ...cloudData };
                            if(!app.history) app.history = {};
                            updateUI();
                            if (!app.tasks || app.tasks.length === 0) checkDailyTasks();
                        } else {
                            save();
                        }
                    }, (error) => {
                        console.log("Sync Error, falling back to local", error);
                        // If permission denied or other sync error, don't crash, just stay
                    });
                } else {
                    // No user, show login screen
                    document.getElementById('login-screen').classList.remove('hidden');
                    updateAuthStatus(false);
                }
            });
        } else {
            fallbackToLocal();
        }

        function parseWords() {
            words = rawWordData.split(';').map(s => {
                const parts = s.split('|');
                return { en: parts[0], tr: parts[1], ctx: parts[2] };
            });
        }

        function save() {
            // Always save local backup
            localStorage.setItem('engApp_v72_local', JSON.stringify(app));
            
            // Try Cloud Sync if connected
            if (!app.isGuest && user && docRef) {
                setDoc(docRef, app, { merge: true }).catch(e => console.log("Cloud Save err", e));
            }
            updateUI();
        }

        function updateUI() {
            render();
            renderTasks();
            renderFavs();
            renderChart();
        }

        function updateHistory(amount) {
            const todayKey = new Date().toISOString().split('T')[0]; 
            if(!app.history) app.history = {};
            if(!app.history[todayKey]) app.history[todayKey] = 0;
            app.history[todayKey] += amount;
        }

        // LOGIC
        function checkDailyTasks() {
            const today = new Date().toDateString();
            if(app.lastLogin !== today) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if(app.lastLogin !== yesterday.toDateString()) {
                    if(app.activeItems && app.activeItems.freeze) {
                        app.activeItems.freeze = false; 
                        toast("❄️ Streak Korumalı!");
                    } else {
                        app.streak = 1;
                    }
                } else {
                    app.streak++;
                }
                app.lastLogin = today;
                generateNewTasks();
                save();
            } else if (!app.tasks || app.tasks.length === 0) {
                generateNewTasks();
            }
        }

        function generateNewTasks() {
            app.tasks = [...taskTemplates].sort(()=>0.5-Math.random()).map(t=>({...t, progress:0, claimed:false}));
            save();
        }

        function updateTask(type, amt) {
            let updated = false;
            if(!app.tasks) return;
            app.tasks.forEach(t => {
                if(t.type===type && !t.claimed && t.progress < t.target) {
                    t.progress += amt;
                    if(t.progress >= t.target) { t.progress = t.target; toast(`Görev Tamamlandı: ${t.text}`); }
                    updated = true;
                }
            });
            if(updated) { save(); }
        }

        window.claimReward = function(idx) {
            const t = app.tasks[idx];
            if(t.progress >= t.target && !t.claimed) {
                t.claimed = true; app.coins += t.reward; app.xp += 10;
                updateHistory(10);
                confetti(); toast(`+${t.reward} Coin Kazandın!`);
                save();
            }
        };

        function findNextWord() {
            let foundIndex = -1;
            for(let i=0; i<words.length; i++) {
                let idx = (app.wordIndex + i) % words.length;
                if(!app.learned.includes(words[idx].en)) {
                    foundIndex = idx;
                    break;
                }
            }
            if(foundIndex === -1) {
                foundIndex = Math.floor(Math.random() * words.length);
            }
            app.wordIndex = foundIndex;
            loadCard();
        }

        function loadCard() {
            if(!words.length) return;
            const w = words[app.wordIndex];
            document.getElementById('fc-en').innerText = w.en;
            document.getElementById('fc-tr').innerText = w.tr;
            document.getElementById('fc-ctx').innerText = w.ctx;
            document.getElementById('flashcard').classList.remove('flipped');
            isFlipped = false;
            
            const isFav = app.favs.includes(w.en);
            const icon = document.getElementById('fav-icon');
            icon.setAttribute('fill', isFav ? 'currentColor' : 'none');
        }

        window.toggleFav = function() {
            const w = words[app.wordIndex].en;
            if(app.favs.includes(w)) app.favs = app.favs.filter(x => x!==w);
            else { app.favs.push(w); toast("Favorilere eklendi"); }
            save(); loadCard(); 
        };

        window.vote = function(known) {
            const w = words[app.wordIndex].en;
            let gainedXp = 10;

            if(known) {
                if(app.activeItems.doubleXP > 0) {
                    gainedXp *= 2;
                    app.activeItems.doubleXP--;
                }
                app.xp += gainedXp; app.coins += 5;
                updateHistory(gainedXp);
                
                if(!app.learned.includes(w)) {
                    app.learned.push(w); updateTask('learn', 1);
                }
                updateTask('xp', gainedXp);
                toast(`+${gainedXp} XP ${app.activeItems.doubleXP>0 ? '⚡' : ''}`);
                confetti();
            }
            
            app.wordIndex++;
            save(); 
            setTimeout(findNextWord, 300);
        };

        // --- QUIZ ---
        window.resetQuiz = function() {
            document.getElementById('quiz-play-area').classList.remove('hidden');
            document.getElementById('quiz-result-area').classList.add('hidden');
            quizState = { active: true, currentQ: 1, score: 0, totalQ: 20 };
            renderQuizQ();
        };

        function renderQuizQ() {
            document.getElementById('quiz-counter').innerText = `${quizState.currentQ} / ${quizState.totalQ}`;
            const target = words[Math.floor(Math.random()*words.length)];
            document.getElementById('q-word').innerText = target.en;
            
            let opts = words.filter(w => w.en !== target.en).sort(()=>0.5-Math.random()).slice(0,3).map(w=>w.tr);
            opts.push(target.tr); opts.sort(()=>0.5-Math.random());
            
            const div = document.getElementById('q-options'); div.innerHTML = '';
            opts.forEach(o => {
                const b = document.createElement('button'); b.className = 'quiz-opt'; b.innerText = o;
                b.onclick = () => handleQuizAns(b, o, target.tr);
                div.appendChild(b);
            });
        }

        function handleQuizAns(btn, selected, correct) {
            const opts = document.querySelectorAll('.quiz-opt');
            opts.forEach(o => o.onclick = null);

            let isCorrect = (selected === correct);
            if(isCorrect) {
                btn.style.background = "rgba(16, 185, 129, 0.3)"; btn.style.borderColor = "var(--neon-green)";
                quizState.score++;
                confetti();
            } else {
                btn.style.background = "rgba(239, 68, 68, 0.3)"; btn.style.borderColor = "var(--neon-red)";
                opts.forEach(o => { if(o.innerText === correct) { o.style.background="rgba(16, 185, 129, 0.3)"; o.style.borderColor="var(--neon-green)"; } });
                if(navigator.vibrate) navigator.vibrate(200);
            }

            setTimeout(() => {
                if(quizState.currentQ < quizState.totalQ) {
                    quizState.currentQ++;
                    renderQuizQ();
                } else {
                    finishQuiz();
                }
            }, 1200);
        }

        function finishQuiz() {
            document.getElementById('quiz-play-area').classList.add('hidden');
            document.getElementById('quiz-result-area').classList.remove('hidden');
            
            let baseXP = quizState.score * 5;
            let finalXP = baseXP;
            if(app.activeItems.doubleXP > 0) {
                finalXP = baseXP * 2;
                app.activeItems.doubleXP = Math.max(0, app.activeItems.doubleXP - 20); 
            }

            app.xp += finalXP;
            updateHistory(finalXP);
            updateTask('xp', finalXP);
            updateTask('quiz', 1);
            save();

            document.getElementById('res-score').innerText = `${quizState.score} / 20`;
            document.getElementById('res-xp').innerText = `+${finalXP}`;
        }

        window.buyItem = function(type, cost) {
            updateTask('shop', 1);
            if(app.coins >= cost) {
                if(type === 'freeze') {
                    if(app.activeItems.freeze) { toast("Zaten Aktif!"); return; }
                    app.activeItems.freeze = true;
                }
                if(type === 'double') {
                    app.activeItems.doubleXP += 20; 
                }
                app.coins -= cost;
                toast("Satın Alındı! 🎉"); confetti();
                save();
            } else {
                toast("Yetersiz Coin");
            }
        };

        function render() {
            document.getElementById('streak-display').innerText = app.streak;
            document.getElementById('coin-display').innerText = app.coins;
            
            const totalWords = words.length;
            const learnedWords = app.learned.length;
            document.getElementById('learn-progress-text').innerText = `${learnedWords} / ${totalWords}`;
            document.getElementById('stat-words').innerText = learnedWords;
            document.getElementById('stat-xp').innerText = app.xp;

            const circle = document.getElementById('mastery-ring');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const percent = Math.min(100, (learnedWords / totalWords) * 100);
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById('mastery-pct').innerText = `${Math.floor(percent)}%`;

            const lvl = Math.floor(app.xp/100) + 1;
            document.getElementById('xp-bar').style.width = (app.xp%100) + "%";
            let title = "Novice";
            if(lvl>2) title = "Beginner"; if(lvl>10) title = "Intermediate"; if(lvl>30) title = "Master";
            document.getElementById('career-badge').innerText = `Lvl ${lvl} • ${title}`;

            const btnFreeze = document.getElementById('btn-freeze');
            if(app.activeItems.freeze) {
                btnFreeze.innerText = "Aktif ✅"; btnFreeze.disabled = true; btnFreeze.style.opacity = 0.6;
            } else {
                btnFreeze.innerText = "200"; btnFreeze.disabled = false; btnFreeze.style.opacity = 1;
            }

            const buffContainer = document.getElementById('active-buffs-container');
            buffContainer.innerHTML = '';
            if(app.activeItems.freeze) buffContainer.innerHTML += `<div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:20px; font-size:0.8rem; margin-right:5px; display:inline-block;">❄️ Korumalı</div>`;
            if(app.activeItems.doubleXP > 0) buffContainer.innerHTML += `<div style="background:rgba(59, 130, 246, 0.2); color:var(--neon-blue); padding:5px 10px; border-radius:20px; font-size:0.8rem; display:inline-block;">⚡ 2x Aktif (${app.activeItems.doubleXP})</div>`;
        }

        function renderChart() {
            const container = document.getElementById('weekly-chart');
            container.innerHTML = '';
            
            const days = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push({
                    key: d.toISOString().split('T')[0],
                    label: d.toLocaleDateString('tr-TR', { weekday: 'short' })
                });
            }
            
            let maxVal = 10; 
            days.forEach(d => {
                const val = app.history ? (app.history[d.key] || 0) : 0;
                if(val > maxVal) maxVal = val;
            });

            days.forEach(d => {
                const val = app.history ? (app.history[d.key] || 0) : 0;
                const heightPct = (val / maxVal) * 100;
                const isToday = d.key === new Date().toISOString().split('T')[0];
                const barColor = isToday ? 'var(--neon-green)' : 'var(--neon-blue)';
                
                container.innerHTML += `
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar" style="height:${heightPct}%; background:${barColor}"></div>
                        <div class="chart-label" style="${isToday?'color:white; font-weight:bold':''}">${d.label}</div>
                    </div>
                `;
            });
        }

        function renderFavs() {
            const list = document.getElementById('favorites-list');
            list.innerHTML = '';
            if(app.favs.length === 0) {
                list.innerHTML = '<div style="color:var(--text-muted); font-size:0.9rem; text-align:center;">Liste boş.</div>';
                return;
            }
            app.favs.forEach(wEn => {
                const wObj = words.find(x => x.en === wEn);
                if(!wObj) return;
                const div = document.createElement('div');
                div.className = 'glass-panel';
                div.style.padding = '15px'; div.style.marginBottom = '10px'; div.style.display = 'flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
                div.innerHTML = `<div><div style="font-weight:700;">${wObj.en}</div><div style="font-size:0.85rem; color:var(--text-muted);">${wObj.tr}</div></div><button class="btn" onclick="removeFav('${wEn}')" style="background:transparent; color:var(--neon-red);">✕</button>`;
                list.appendChild(div);
            });
        }
        
        window.removeFav = function(w) { app.favs = app.favs.filter(x => x !== w); save(); };

        function renderTasks() {
            const c = document.getElementById('quests-container'); c.innerHTML = '';
            if(!app.tasks) return;
            app.tasks.forEach((t, i) => {
                const isDone = t.progress >= t.target;
                const pct = (t.progress/t.target)*100;
                let action = isDone && !t.claimed ? `<button class="btn" style="background:var(--neon-green); color:#000; padding:6px 12px; border-radius:8px; font-size:0.8rem;" onclick="claimReward(${i})">Al</button>` : (t.claimed ? `<span style="color:var(--neon-green); font-size:0.8rem;">Tamam</span>` : `<span style="font-size:0.8rem; color:var(--text-muted);">${t.progress}/${t.target}</span>`);
                c.innerHTML += `<div class="glass-panel quest-card ${isDone?'completed':''}"><div class="quest-row"><span class="quest-title">${t.text}</span><span class="quest-reward">+${t.reward}</span></div><div style="display:flex; align-items:center; gap:15px;"><div style="flex:1; height:6px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden;"><div style="height:100%; background:var(--neon-green); width:${pct}%"></div></div>${action}</div></div>`;
            });
        }

        window.switchTab = function(id, btn) {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(id === 'quiz') resetQuiz(); 
            if(id === 'profile') renderChart();
        };

        window.flipCard = function() { document.getElementById('flashcard').classList.toggle('flipped'); isFlipped = !isFlipped; };
        window.playTTS = function() { const t = new SpeechSynthesisUtterance(words[app.wordIndex].en); t.lang = 'en-US'; speechSynthesis.speak(t); };
        function toast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }
        window.resetData = function() { if(confirm("Reset all data?")) { localStorage.removeItem('engApp_v72_local'); location.reload(); } };
        function confetti() {
            const c = document.getElementById('confetti-canvas'); const x = c.getContext('2d'); c.width=window.innerWidth; c.height=window.innerHeight;
            const p = Array(40).fill().map(()=>({x:c.width/2, y:c.height/2, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, color:['#3b82f6','#8b5cf6','#10b981'][Math.floor(Math.random()*3)], life:80}));
            function draw(){ x.clearRect(0,0,c.width,c.height); let a=false; p.forEach(i=>{ if(i.life>0){ i.x+=i.vx; i.y+=i.vy; i.vy+=0.5; i.life--; x.fillStyle=i.color; x.fillRect(i.x,i.y,6,6); a=true; }}); if(a) requestAnimationFrame(draw); } draw();
        }

        // AUTH FUNCTIONS
        window.loginWithGoogle = function() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    // Handled by onAuthStateChanged
                }).catch((error) => {
                    console.error(error);
                    // Improved Error Handling
                    if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                        alert("HATA: Google Girişi Etkin Değil!\n\nLütfen Firebase Konsolu -> Authentication -> Sign-in method sekmesine gidin ve 'Google' sağlayıcısını etkinleştirin.");
                    } else {
                        alert("Giriş hatası: " + error.message);
                    }
                });
        };

        window.loginGuest = function() {
            signInAnonymously(auth).catch((error) => {
                console.error(error);
                fallbackToLocal();
            });
        };

        window.logout = function() {
            if (!app.isGuest) {
                signOut(auth).then(() => {
                    location.reload();
                });
            } else {
                location.reload();
            }
        };

        function updateAuthStatus(loggedIn, isLocal = false) {
            const dot = document.getElementById('auth-dot');
            const text = document.getElementById('auth-text');
            if(isLocal) {
                dot.style.background = 'var(--neon-orange)';
                dot.style.boxShadow = '0 0 10px var(--neon-orange)';
                text.innerText = 'Yerel Mod (Çevrimdışı)';
            } else if(loggedIn) {
                dot.style.background = 'var(--neon-green)';
                dot.style.boxShadow = '0 0 10px var(--neon-green)';
                text.innerText = 'Bulut (Çevrimiçi)';
            } else {
                dot.style.background = 'var(--text-muted)';
                dot.style.boxShadow = 'none';
                text.innerText = 'Giriş Yapılmadı';
            }
        }
    </script>
</body>
</html>