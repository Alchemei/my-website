<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro PDF Studio v3 - Modern UI</title>

    <!-- Fontlar ve İkonlar -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <!-- Kütüphaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <style>
      :root {
        --bg-main: #f8fafc;
        --bg-panel: #ffffff;
        --border: #e2e8f0;
        --primary: #4f46e5; /* Indigo 600 */
        --primary-hover: #4338ca;
        --text-main: #0f172a;
        --text-sub: #64748b;
        --danger: #ef4444;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      * { box-sizing: border-box; outline: none; user-select: none; font-family: 'Inter', sans-serif; }
      body { margin: 0; background: var(--bg-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); }

      /* --- HEADER --- */
      header {
        height: 56px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .logo { font-weight: 700; font-size: 16px; display: flex; gap: 8px; align-items: center; color: var(--text-main); letter-spacing: -0.5px; }
      .logo i { color: var(--primary); font-size: 24px; }
      
      .header-center { display: flex; gap: 10px; align-items: center; }
      
      .btn {
        display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 6px;
        font-size: 13px; font-weight: 500; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        color: var(--text-sub); background: transparent;
      }
      .btn:hover { background: #f1f5f9; color: var(--text-main); }
      .btn.primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3); }
      .btn.primary:hover { background: var(--primary-hover); }
      
      /* --- MAIN LAYOUT (3-COLUMN) --- */
      .layout { display: flex; flex: 1; overflow: hidden; }

      /* 1. LEFT SIDEBAR (TOOLS & THUMBS) */
      .left-panel {
        width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border);
        display: flex; flex-direction: column; z-index: 40;
      }
      
      /* Tool Strip */
      .tools-grid {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 15px;
        border-bottom: 1px solid var(--border);
      }
      .tool-btn {
        aspect-ratio: 1; border-radius: 8px; border: 1px solid transparent; background: #f8fafc;
        color: var(--text-sub); cursor: pointer; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; transition: 0.2s; position: relative;
      }
      .tool-btn i { font-size: 22px; margin-bottom: 2px; }
      .tool-btn span { font-size: 9px; font-weight: 600; }
      .tool-btn:hover { background: #e0e7ff; color: var(--primary); }
      .tool-btn.active { background: var(--primary); color: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
      
      /* Thumbnails */
      .thumbs-area { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }
      .thumb-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin-bottom: 10px; letter-spacing: 0.5px; }
      .thumb-card { 
        position: relative; cursor: pointer; margin-bottom: 15px; border-radius: 4px; 
        transition: 0.2s; border: 2px solid transparent;
      }
      .thumb-card.active { border-color: var(--primary); }
      .thumb-card img { width: 100%; border-radius: 2px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: block; }
      .thumb-num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
      .thumb-del {
        position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: var(--danger); color: white;
        border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;
        opacity: 0; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .thumb-card:hover .thumb-del { opacity: 1; }

      /* 2. CENTER (CANVAS) */
      .center-panel {
        flex: 1; background: #e2e8f0; position: relative; overflow: auto;
        display: flex; justify-content: center; padding: 60px;
        /* Modern Grid Pattern */
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 24px 24px;
      }
      
      /* PDF Container */
      #pdf-wrapper {
        position: relative; background: white; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
        transition: width 0.15s cubic-bezier(0.4, 0, 0.2, 1), height 0.15s;
      }
      #pdf-canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none; }
      #draw-canvas { display: block; position: absolute; top: 0; left: 0; z-index: 5; pointer-events: none; }
      #draw-canvas.active { pointer-events: auto; cursor: crosshair; }
      
      /* Selection / Magic Box */
      #selection-marquee {
        position: absolute; border: 2px dashed var(--primary); background: rgba(79, 70, 229, 0.1);
        display: none; pointer-events: none; z-index: 999;
      }

      /* Objects */
      .obj { position: absolute; z-index: 10; cursor: grab; transform-origin: top left; }
      .obj:active { cursor: grabbing; }
      .obj:hover { outline: 1px dashed var(--primary); }
      .obj.selected { outline: 2px solid var(--primary); z-index: 100 !important; }
      
      /* Object Handles (Resize) - CSS Magic for better UX */
      .obj.selected::after {
        content: ''; position: absolute; bottom: -4px; right: -4px; width: 8px; height: 8px;
        background: var(--primary); border-radius: 50%; cursor: nwse-resize;
      }

      .obj-text { white-space: pre-wrap; line-height: 1.2; padding: 2px; min-width: 10px; }
      .obj-text:focus { outline: none; background: rgba(255,255,255,0.9); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      .obj-text.with-bg { background: white; /* For Smart Edit */ }

      /* 3. RIGHT PANEL (PROPERTIES) */
      .right-panel {
        width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border);
        display: flex; flex-direction: column; z-index: 40;
      }
      .prop-header { padding: 20px 15px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 14px; color: var(--text-main); }
      .prop-content { padding: 20px; flex: 1; overflow-y: auto; }
      
      .prop-group { margin-bottom: 20px; }
      .prop-label { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; display: block; }
      .prop-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
      .prop-input { 
        flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--text-main);
        transition: 0.2s; width: 100%;
      }
      .prop-input:focus { border-color: var(--primary); }
      input[type="color"] { padding: 0; height: 36px; cursor: pointer; }

      .empty-state { text-align: center; color: var(--text-sub); font-size: 13px; margin-top: 50px; padding: 20px; }
      .empty-state i { font-size: 48px; margin-bottom: 10px; opacity: 0.3; display: block; }

      /* BOTTOM BAR (Zoom & Nav) */
      .bottom-bar {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: var(--bg-panel); padding: 6px 12px; border-radius: 100px;
        display: flex; align-items: center; gap: 12px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        border: 1px solid var(--border); z-index: 60;
      }
      .zoom-val { font-size: 13px; font-weight: 600; color: var(--text-main); min-width: 40px; text-align: center; }

      /* OVERLAYS */
      #overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
      .hidden { display: none !important; }
      .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
      @keyframes spin { to { transform: rotate(360deg); } }

    </style>
  </head>
  <body>

    <!-- DRAG DROP & LOADING -->
    <div id="overlay">
      <div id="drop-area" style="text-align:center">
        <div style="width:80px; height:80px; background:#e0e7ff; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
          <i class="material-symbols-rounded" style="font-size:40px; color:var(--primary)">upload_file</i>
        </div>
        <h1 style="font-size:24px; font-weight:700; margin-bottom:8px">PDF Düzenleyici</h1>
        <p style="color:var(--text-sub); margin-bottom:24px">Düzenlemek için dosyanızı sürükleyin veya seçin</p>
        <button class="btn primary" style="padding:12px 24px; font-size:14px" onclick="document.getElementById('fileIn').click()">
          Dosya Seç
        </button>
      </div>
      <div id="loader" class="hidden" style="text-align:center">
        <div class="spinner"></div>
        <p style="margin-top:16px; font-weight:500">PDF Hazırlanıyor...</p>
      </div>
    </div>
    <input type="file" id="fileIn" hidden accept="application/pdf">
    <input type="file" id="imgIn" hidden accept="image/*">

    <!-- HEADER -->
    <header>
      <div class="logo"><i class="material-symbols-rounded">edit_document</i> Pro PDF Studio</div>
      
      <div class="header-center">
        <button class="btn" onclick="undo()" title="Geri Al (Ctrl+Z)">
          <i class="material-symbols-rounded">undo</i>
        </button>
        <div style="width:1px; height:20px; background:var(--border)"></div>
        <span id="page-info" style="font-size:13px; font-weight:500; color:var(--text-sub)">Sayfa 0 / 0</span>
      </div>

      <div>
        <button class="btn primary" id="saveBtn">
          <i class="material-symbols-rounded">download</i> İndir
        </button>
      </div>
    </header>

    <div class="layout">
      <!-- 1. LEFT PANEL (TOOLS) -->
      <aside class="left-panel">
        <div class="tools-grid">
          <button class="tool-btn active" id="t-select" onclick="setTool('select')" title="Seçim Aracı (V)">
            <i class="material-symbols-rounded">near_me</i> <span>Seç</span>
          </button>
          <button class="tool-btn" id="t-smart" onclick="setTool('smart')" title="Akıllı Metin Düzenle">
            <i class="material-symbols-rounded">edit_note</i> <span>Akıllı Düz.</span>
          </button>
          <button class="tool-btn" onclick="createObject('text')" title="Metin Ekle">
            <i class="material-symbols-rounded">title</i> <span>Metin</span>
          </button>
          <button class="tool-btn" onclick="document.getElementById('imgIn').click()" title="Resim Ekle">
            <i class="material-symbols-rounded">image</i> <span>Resim</span>
          </button>
          <button class="tool-btn" onclick="createObject('rect')" title="Kutu">
            <i class="material-symbols-rounded">check_box_outline_blank</i> <span>Kutu</span>
          </button>
          <button class="tool-btn" onclick="createObject('circle')" title="Daire">
            <i class="material-symbols-rounded">circle</i> <span>Daire</span>
          </button>
          <button class="tool-btn" id="t-draw" onclick="setTool('draw')" title="Serbest Çizim">
            <i class="material-symbols-rounded">ink_pen</i> <span>Çizim</span>
          </button>
          <button class="tool-btn" onclick="createObject('line')" title="Çizgi">
            <i class="material-symbols-rounded">horizontal_rule</i> <span>Çizgi</span>
          </button>
        </div>
        
        <div style="padding:15px 15px 5px 15px;">
          <div class="thumb-title">Sayfalar</div>
        </div>
        <div class="thumbs-area" id="thumbs"></div>
      </aside>

      <!-- 2. CENTER (WORKSPACE) -->
      <main class="center-panel" id="workspace">
        <div id="pdf-wrapper">
          <canvas id="pdf-canvas"></canvas>
          <canvas id="draw-canvas"></canvas>
          <div id="selection-marquee"></div>
        </div>

        <div class="bottom-bar">
          <button class="btn" onclick="changeZoom(-0.2)"><i class="material-symbols-rounded">remove</i></button>
          <span class="zoom-val" id="zoom-val">100%</span>
          <button class="btn" onclick="changeZoom(0.2)"><i class="material-symbols-rounded">add</i></button>
        </div>
      </main>

      <!-- 3. RIGHT PANEL (PROPERTIES) -->
      <aside class="right-panel">
        <div class="prop-header">Özellikler</div>
        <div class="prop-content" id="prop-content">
          <div class="empty-state">
            <i class="material-symbols-rounded">touch_app</i>
            Düzenlemek için bir nesne seçin veya araç kullanın.
          </div>
        </div>
      </aside>
    </div>

    <script>
      // --- CORE ENGINE ---
      let pdfDoc = null, pdfBytes = null;
      let scale = 1.0, currPage = 1;
      let tool = 'select';
      let objects = []; // {id, type, page, baseX, baseY, baseW, baseH, style:{}}
      let historyStack = [];
      let paths = {}; // {pageNum: [[{x,y}...]]}
      let deletedPages = new Set();
      
      // Resources
      let customFont = null;
      (async() => { try { customFont = await fetch('https://cdn.jsdelivr.net/npm/inter-ui@3.19.3/Inter%20(web)/Inter-Regular.woff').then(r=>r.arrayBuffer()) } catch(e){} })();
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

      // --- INIT HANDLERS ---
      const overlay = document.getElementById('overlay');
      overlay.ondragover = e => { e.preventDefault(); };
      overlay.ondrop = e => { e.preventDefault(); loadPDF(e.dataTransfer.files[0]); };
      document.getElementById('fileIn').onchange = e => loadPDF(e.target.files[0]);
      document.getElementById('imgIn').onchange = e => createObject('image', e.target.files[0]);

      async function loadPDF(file) {
        if(!file || file.type!=='application/pdf') return alert('PDF dosyası seçiniz.');
        document.getElementById('drop-area').classList.add('hidden');
        document.getElementById('loader').classList.remove('hidden');
        try {
          pdfBytes = await file.arrayBuffer();
          pdfDoc = await pdfjsLib.getDocument(pdfBytes).promise;
          overlay.classList.add('hidden');
          genThumbs();
          renderPage(1);
        } catch(e) {
          alert('Hata: ' + e.message);
          location.reload();
        }
      }

      // --- RENDER LOGIC (ROBUST) ---
      async function renderPage(num) {
        if(deletedPages.has(num)) return;
        currPage = num;
        document.getElementById('page-info').innerText = `Sayfa ${currPage} / ${pdfDoc.numPages}`;
        
        // Highlight Thumb
        document.querySelectorAll('.thumb-card').forEach(el => el.classList.remove('active'));
        const t = document.getElementById('thumb-'+num);
        if(t) t.classList.add('active');

        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale });

        // Fix Container & Canvases
        const wrapper = document.getElementById('pdf-wrapper');
        wrapper.style.width = Math.floor(viewport.width) + 'px';
        wrapper.style.height = Math.floor(viewport.height) + 'px';
        
        const cvs = document.getElementById('pdf-canvas');
        const dCvs = document.getElementById('draw-canvas');
        cvs.width = dCvs.width = Math.floor(viewport.width);
        cvs.height = dCvs.height = Math.floor(viewport.height);

        await page.render({ canvasContext: cvs.getContext('2d'), viewport }).promise;

        drawPaths();
        updateObjects();
        updatePropPanel();
        document.getElementById('zoom-val').innerText = Math.round(scale*100) + '%';
      }

      function changeZoom(delta) {
        if(scale+delta < 0.3) return;
        scale += delta;
        renderPage(currPage);
      }

      // --- TOOL SWITCHING ---
      function setTool(t) {
        tool = t;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('t-'+ (t==='select'?'select':(t==='smart'?'smart':'draw')) );
        if(btn) btn.classList.add('active');

        const dCvs = document.getElementById('draw-canvas');
        dCvs.classList.toggle('active', t === 'draw');
        
        const wrap = document.getElementById('pdf-wrapper');
        wrap.style.cursor = (t==='smart') ? 'crosshair' : 'default';
        
        if(t !== 'select') deselect();
      }

      // --- OBJECT MANAGEMENT ---
      function updateObjects() {
        objects.forEach(obj => {
          if(obj.page !== currPage) { obj.el.style.display = 'none'; return; }
          obj.el.style.display = 'block';
          
          // Calculate Pixel Coords from Base
          const x = obj.baseX * scale;
          const y = obj.baseY * scale;
          const w = obj.baseW * scale;
          const h = obj.baseH * scale;

          obj.el.style.left = x + 'px';
          obj.el.style.top = y + 'px';
          obj.el.style.width = w + 'px';
          obj.el.style.height = h + 'px';
          
          // Styles
          if(obj.type === 'text') {
            obj.el.style.fontSize = (parseFloat(obj.style.fontSize) * scale) + 'px';
            obj.el.style.color = obj.style.color;
            if(obj.style.bg) obj.el.style.background = obj.style.bg;
          } else {
            obj.el.style.borderColor = obj.style.borderColor;
            obj.el.style.borderWidth = (parseFloat(obj.style.borderWidth) * scale) + 'px';
            obj.el.style.backgroundColor = obj.style.bg || 'transparent';
          }
          
          // Reset Interact Transforms
          obj.el.style.transform = 'none';
          obj.el.setAttribute('data-x', 0);
          obj.el.setAttribute('data-y', 0);
        });
      }

      function createObject(type, payload=null, rect=null, extraStyles={}) {
        const id = Date.now();
        const el = document.createElement('div');
        el.classList.add('obj');
        el.dataset.id = id;
        
        const wrapper = document.getElementById('pdf-wrapper');
        // Default center
        let startX = rect ? rect.x/scale : (wrapper.clientWidth/2/scale - 50);
        let startY = rect ? rect.y/scale : (wrapper.clientHeight/2/scale - 20);
        let baseW = rect ? rect.w/scale : 100;
        let baseH = rect ? rect.h/scale : 50;

        let style = { color: '#000000', borderColor: '#000000', borderWidth: 2, fontSize: 16, bg: null, ...extraStyles };

        if(type === 'text') {
          el.classList.add('obj-text');
          el.contentEditable = true;
          el.innerText = payload || 'Metin';
          if(style.bg) el.classList.add('with-bg');
          baseW = rect ? baseW : 'auto';
          baseH = rect ? baseH : 'auto';
        } else if (type === 'rect' || type === 'line') {
          el.classList.add('obj-box');
          el.style.borderStyle = 'solid';
          if(type==='line') { baseH = 2; style.bg = style.borderColor; }
        } else if (type === 'circle') {
          el.classList.add('obj-circle');
          el.style.borderStyle = 'solid';
          baseH = 100;
        } else if (type === 'image') {
          const img = document.createElement('img');
          const r = new FileReader();
          r.onload = e => img.src = e.target.result;
          r.readAsDataURL(payload);
          img.style.width = '100%'; img.style.height = '100%'; img.draggable = false;
          el.appendChild(img);
          baseW = 200; baseH = 150;
        }

        document.getElementById('pdf-wrapper').appendChild(el);
        const obj = { id, type, page: currPage, el, baseX: startX, baseY: startY, baseW, baseH, style };
        objects.push(obj);
        historyStack.push({action:'add', id});

        setupInteract(el, obj);
        updateObjects();
        selectObject(obj);
        
        if(tool !== 'smart') setTool('select');
      }

      function setupInteract(el, obj) {
        interact(el)
          .draggable({
            listeners: {
              move(e) {
                if(tool !== 'select') return;
                // Calc changes
                const curX = parseFloat(el.style.left) + e.dx;
                const curY = parseFloat(el.style.top) + e.dy;
                el.style.left = curX + 'px';
                el.style.top = curY + 'px';
                // Update Base
                obj.baseX = curX / scale;
                obj.baseY = curY / scale;
              }
            },
            modifiers: [ interact.modifiers.restrictRect({restriction:'parent', endOnly:true}) ]
          })
          .resizable({
            edges: {left:true, right:true, bottom:true, top:true},
            listeners: {
              move(e) {
                if(tool!=='select') return;
                const curX = parseFloat(el.style.left) + e.deltaRect.left;
                const curY = parseFloat(el.style.top) + e.deltaRect.top;
                el.style.width = e.rect.width+'px'; el.style.height = e.rect.height+'px';
                el.style.left = curX+'px'; el.style.top = curY+'px';
                
                obj.baseW = e.rect.width/scale; obj.baseH = e.rect.height/scale;
                obj.baseX = curX/scale; obj.baseY = curY/scale;
              }
            }
          })
          .on('down', () => selectObject(obj));
      }

      // --- SMART EDIT (MAGIC TEXT) ---
      const marquee = document.getElementById('selection-marquee');
      let isSel = false, startPos = {};
      
      document.getElementById('pdf-wrapper').addEventListener('mousedown', e => {
        if(tool !== 'smart' || e.target.closest('.obj')) return;
        isSel = true;
        const r = document.getElementById('pdf-wrapper').getBoundingClientRect();
        startPos = { x: e.clientX - r.left, y: e.clientY - r.top };
        marquee.style.display = 'block'; marquee.style.width='0'; marquee.style.height='0';
        marquee.style.left = startPos.x+'px'; marquee.style.top = startPos.y+'px';
      });

      document.getElementById('pdf-wrapper').addEventListener('mousemove', e => {
        if(!isSel) return;
        const r = document.getElementById('pdf-wrapper').getBoundingClientRect();
        const cx = e.clientX - r.left, cy = e.clientY - r.top;
        const w = Math.abs(cx - startPos.x), h = Math.abs(cy - startPos.y);
        marquee.style.left = Math.min(cx, startPos.x)+'px';
        marquee.style.top = Math.min(cy, startPos.y)+'px';
        marquee.style.width = w+'px'; marquee.style.height = h+'px';
      });

      document.getElementById('pdf-wrapper').addEventListener('mouseup', async () => {
        if(!isSel) return; isSel = false; marquee.style.display = 'none';
        const rect = {
          x: parseFloat(marquee.style.left), y: parseFloat(marquee.style.top),
          w: parseFloat(marquee.style.width), h: parseFloat(marquee.style.height)
        };
        if(rect.w > 5 && rect.h > 5) {
          // OCR Logic
          const page = await pdfDoc.getPage(currPage);
          const tc = await page.getTextContent();
          const vp = page.getViewport({scale});
          // Map to PDF
          const p1 = vp.convertToPdfPoint(rect.x, rect.y);
          const p2 = vp.convertToPdfPoint(rect.x+rect.w, rect.y+rect.h);
          const minX = Math.min(p1[0], p2[0]), maxX = Math.max(p1[0], p2[0]);
          const minY = Math.min(p1[1], p2[1]), maxY = Math.max(p1[1], p2[1]);
          
          let str = "", maxH = 0;
          tc.items.forEach(i => {
             // Basic collision detection
             if(i.transform[4] >= minX && i.transform[4] <= maxX && i.transform[5] >= minY && i.transform[5] <= maxY) {
               str += i.str + " ";
               if(i.height > maxH) maxH = i.height;
             }
          });
          
          // Create Covering Text Box
          createObject('text', str.trim() || 'Metin', rect, { bg: '#ffffff', fontSize: maxH || 12 });
          setTool('select');
        }
      });

      // --- PROPERTIES PANEL (MODERN) ---
      let selectedObj = null;
      function selectObject(obj) {
        if(selectedObj) selectedObj.el.classList.remove('selected');
        selectedObj = obj;
        obj.el.classList.add('selected');
        updatePropPanel();
      }
      function deselect() {
        if(selectedObj) selectedObj.el.classList.remove('selected');
        selectedObj = null;
        updatePropPanel();
      }
      document.getElementById('workspace').addEventListener('mousedown', e => {
        if(e.target.id==='workspace' || e.target.id==='pdf-wrapper') deselect();
      });

      function updatePropPanel() {
        const p = document.getElementById('prop-content');
        if(!selectedObj) {
          p.innerHTML = `
            <div class="empty-state">
              <i class="material-symbols-rounded">touch_app</i>
              Bir nesne seçin.
            </div>`;
          return;
        }
        const o = selectedObj;
        let html = '';

        // Common actions
        html += `
          <div class="prop-group">
            <span class="prop-label">Eylemler</span>
            <div class="prop-row">
              <button class="btn primary" style="flex:1; justify-content:center" onclick="changeLayer(1)">Öne Getir</button>
              <button class="btn" style="flex:1; justify-content:center; background:#e2e8f0" onclick="changeLayer(-1)">Alta Gönder</button>
            </div>
            <div class="prop-row">
              <button class="btn" style="width:100%; justify-content:center; color:#ef4444; background:#fee2e2" onclick="deleteObj()">
                <i class="material-symbols-rounded" style="font-size:16px">delete</i> Nesneyi Sil
              </button>
            </div>
          </div>
        `;

        // Type specific
        if(o.type === 'text') {
           html += `
             <div class="prop-group">
               <span class="prop-label">Yazı Ayarları</span>
               <div class="prop-row">
                 <span>Boyut</span>
                 <input type="number" class="prop-input" value="${o.style.fontSize}" onchange="setStyle('fontSize', this.value)">
               </div>
               <div class="prop-row">
                 <span>Renk</span>
                 <input type="color" value="${o.style.color}" onchange="setStyle('color', this.value)">
               </div>
               <div class="prop-row">
                 <span>Arka Plan</span>
                 <div style="display:flex; align-items:center; gap:5px">
                   <input type="checkbox" ${o.style.bg ? 'checked' : ''} onchange="setStyle('bg', this.checked ? '#ffffff' : null)">
                   <span>Beyaz Dolgu</span>
                 </div>
               </div>
             </div>
           `;
        } else if (o.type !== 'image') {
           html += `
             <div class="prop-group">
               <span class="prop-label">Şekil Ayarları</span>
               <div class="prop-row">
                 <span>Kalınlık</span>
                 <input type="number" class="prop-input" value="${o.style.borderWidth}" onchange="setStyle('borderWidth', this.value)">
               </div>
               <div class="prop-row">
                 <span>Çizgi Rengi</span>
                 <input type="color" value="${o.style.borderColor}" onchange="setStyle('borderColor', this.value)">
               </div>
               <div class="prop-row">
                 <span>Dolgu Rengi</span>
                 <input type="color" value="${o.style.bg || '#ffffff'}" onchange="setStyle('bg', this.value)">
               </div>
             </div>
           `;
        }
        p.innerHTML = html;
      }

      function setStyle(k, v) {
        if(!selectedObj) return;
        if(k === 'fontSize' || k === 'borderWidth') v = parseFloat(v);
        selectedObj.style[k] = v;
        updateObjects();
      }
      function deleteObj() {
        if(!selectedObj) return;
        selectedObj.el.remove();
        objects = objects.filter(x => x.id !== selectedObj.id);
        deselect();
      }
      function changeLayer(dir) {
        if(!selectedObj) return;
        let z = parseInt(getComputedStyle(selectedObj.el).zIndex);
        selectedObj.el.style.zIndex = z + dir;
      }

      // --- DRAWING ---
      const dCvs = document.getElementById('draw-canvas');
      const dCtx = dCvs.getContext('2d');
      let isDrawing = false;
      
      dCvs.addEventListener('mousedown', e => {
        if(tool!=='draw') return; isDrawing=true;
        const r = dCvs.getBoundingClientRect();
        const pt = {x:(e.clientX-r.left)/scale, y:(e.clientY-r.top)/scale};
        if(!paths[currPage]) paths[currPage]=[];
        paths[currPage].push([pt]);
      });
      dCvs.addEventListener('mousemove', e => {
        if(!isDrawing) return;
        const r = dCvs.getBoundingClientRect();
        const pt = {x:(e.clientX-r.left)/scale, y:(e.clientY-r.top)/scale};
        paths[currPage][paths[currPage].length-1].push(pt);
        drawPaths();
      });
      dCvs.addEventListener('mouseup', ()=>isDrawing=false);
      
      function drawPaths() {
        dCtx.clearRect(0,0,dCvs.width,dCvs.height);
        if(!paths[currPage]) return;
        dCtx.lineWidth = 2 * scale; dCtx.lineCap='round'; dCtx.strokeStyle='#2563eb';
        paths[currPage].forEach(p => {
           if(p.length<2) return;
           dCtx.beginPath();
           dCtx.moveTo(p[0].x*scale, p[0].y*scale);
           for(let i=1; i<p.length; i++) dCtx.lineTo(p[i].x*scale, p[i].y*scale);
           dCtx.stroke();
        });
      }

      // --- THUMBNAILS ---
      async function genThumbs() {
        const t = document.getElementById('thumbs'); t.innerHTML = '';
        for(let i=1; i<=pdfDoc.numPages; i++) {
           const card = document.createElement('div'); card.className='thumb-card'; card.id='thumb-'+i;
           card.onclick = () => renderPage(i);
           
           const img = document.createElement('img');
           card.append(img);
           
           const num = document.createElement('div'); num.className='thumb-num'; num.innerText = i;
           card.append(num);

           const del = document.createElement('div'); del.className='thumb-del'; del.innerHTML='×';
           del.onclick = e => { e.stopPropagation(); deletePage(i); };
           card.append(del);

           t.append(card);

           pdfDoc.getPage(i).then(p => {
             const v = p.getViewport({scale:0.15});
             const c = document.createElement('canvas'); c.width=v.width; c.height=v.height;
             p.render({canvasContext:c.getContext('2d'), viewport:v}).promise.then(()=>img.src=c.toDataURL());
           });
        }
      }
      function deletePage(n) {
        if(!confirm('Sayfa silinsin mi?')) return;
        deletedPages.add(n);
        document.getElementById('thumb-'+n).style.display='none';
        if(currPage===n) renderPage(n>1?n-1:n+1);
      }

      function undo() {
        if(!historyStack.length) return;
        const act = historyStack.pop();
        if(act.action==='add') {
          const o = objects.find(x=>x.id===act.id);
          if(o) { o.el.remove(); objects = objects.filter(x=>x.id!==act.id); deselect(); }
        }
      }

      // --- SAVING ---
      document.getElementById('saveBtn').onclick = async () => {
        if(!pdfBytes) return;
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('drop-area').classList.add('hidden');
        
        setTimeout(async () => {
          try {
            const {PDFDocument, rgb} = PDFLib;
            const pdf = await PDFDocument.load(pdfBytes);
            pdf.registerFontkit(fontkit);
            const font = customFont ? await pdf.embedFont(customFont) : await pdf.embedFont(PDFLib.StandardFonts.Helvetica);

            const delSorted = Array.from(deletedPages).sort((a,b)=>b-a);
            for(const p of delSorted) pdf.removePage(p-1);

            const pages = pdf.getPages();
            let pIdx = 0;
            
            for(let i=1; i<=pdfDoc.numPages; i++) {
              if(deletedPages.has(i)) continue;
              const page = pages[pIdx];
              const {width, height} = page.getSize();

              // Drawings
              if(paths[i]) {
                 paths[i].forEach(p => {
                   for(let k=0; k<p.length-1; k++) {
                      page.drawLine({
                        start: {x:p[k].x, y:height-p[k].y},
                        end: {x:p[k+1].x, y:height-p[k+1].y},
                        thickness: 2, color: rgb(0.14, 0.38, 0.92)
                      });
                   }
                 });
              }

              // Objects
              const pObjs = objects.filter(x => x.page === i).sort((a,b) => parseInt(a.el.style.zIndex)-parseInt(b.el.style.zIndex));
              for(const o of pObjs) {
                 const pdfY = height - o.baseY - o.baseH;
                 const col = hexToRgb(o.style.color||'#000000');
                 const bor = hexToRgb(o.style.borderColor||'#000000');
                 const bg = o.style.bg ? hexToRgb(o.style.bg) : null;

                 if(o.type === 'text') {
                   const fSize = parseFloat(o.style.fontSize);
                   
                   // Zorlu Genişlik/Yükseklik Hesabı
                   let limitWidth = o.baseW;
                   let domWidth = 0, domHeight = 0;

                   // Gizli elemanı görünür yapıp ölç
                   const wasHidden = o.el.style.display === 'none';
                   if(wasHidden) { o.el.style.visibility = 'hidden'; o.el.style.display = 'block'; }
                   
                   domWidth = o.el.offsetWidth;
                   domHeight = o.el.offsetHeight;
                   
                   if(wasHidden) { o.el.style.display = 'none'; o.el.style.visibility = 'visible'; }

                   const rectHeight = domHeight / scale;
                   if(limitWidth === 'auto' || !limitWidth) limitWidth = domWidth / scale;
                   
                   if(bg) page.drawRectangle({
                     x: o.baseX, 
                     // Metni ve kutuyu tam sarması için doğru Y koordinatı
                     y: height - o.baseY - rectHeight, 
                     width: limitWidth, 
                     height: rectHeight, 
                     color: rgb(bg.r,bg.g,bg.b)
                   });

                   page.drawText(o.el.innerText, {
                     x: o.baseX, 
                     y: height - o.baseY - fSize, // Baseline
                     size: fSize, 
                     font, 
                     color: rgb(col.r,col.g,col.b),
                     maxWidth: limitWidth,
                     lineHeight: fSize * 1.2
                   });
                 } else if (o.type === 'rect' || o.type === 'line') {
                   let opts = { x:o.baseX, y:pdfY, width:o.baseW, height:o.baseH, borderColor:rgb(bor.r,bor.g,bor.b), borderWidth:parseFloat(o.style.borderWidth) };
                   if(bg) opts.color = rgb(bg.r,bg.g,bg.b);
                   page.drawRectangle(opts);
                 } else if (o.type === 'circle') {
                   let opts = { x:o.baseX+o.baseW/2, y:pdfY+o.baseH/2, xScale:o.baseW/2, yScale:o.baseH/2, borderColor:rgb(bor.r,bor.g,bor.b), borderWidth:parseFloat(o.style.borderWidth) };
                   if(bg) opts.color = rgb(bg.r,bg.g,bg.b);
                   page.drawEllipse(opts);
                 } else if (o.type === 'image') {
                   const buff = await fetch(o.el.querySelector('img').src).then(r=>r.arrayBuffer());
                   const emb = await pdf.embedPng(buff).catch(()=>pdf.embedJpg(buff));
                   page.drawImage(emb, {x:o.baseX, y:pdfY, width:o.baseW, height:o.baseH});
                 }
              }
              pIdx++;
            }
            
            const out = await pdf.save();
            const blob = new Blob([out], {type:'application/pdf'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Pro_Edited.pdf'; a.click();
            overlay.classList.add('hidden');
            document.getElementById('drop-area').classList.remove('hidden');
          } catch(e) {
            alert('Hata: '+e.message);
            overlay.classList.add('hidden');
          }
        }, 100);
      };

      function hexToRgb(hex) {
        const r=parseInt(hex.slice(1,3),16)/255, g=parseInt(hex.slice(3,5),16)/255, b=parseInt(hex.slice(5,7),16)/255;
        return {r,g,b};
      }
    </script>
  </body>
</html>